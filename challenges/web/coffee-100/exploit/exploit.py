#!/usr/bin/python3
import requests,time
from requests.auth import HTTPBasicAuth

url = "https://coffee.insecurity-insa.fr/"
creds = HTTPBasicAuth('Coffee_Machine', 'Coffee_Password')

def alive():
    r = requests.get(url+'teapot',auth=creds)
    return r.text == "I'm a teapot" and r.status_code == 418

def exploitable():
    s = requests.Session()
    s.headers.update({'content-type': 'message/coffeepot'})
    s.request('BREW',url+'coffee',data='start',auth=creds,headers={"milk-type":"Half-and-half","syrup-type":"Raspberry"})

    time.sleep(16)

    s.request('PROPFIND',url+'coffee',auth=creds)
    s.request('BREW',url+'coffee',data='stop',auth=creds)
    s.request('BREW',url+'coffee',data='milk',auth=creds)

    time.sleep(5)

    r = s.request('PROPFIND',url+'coffee',auth=creds)
    a = (r.text == "There is enough milk, you can stop pouring it." and r.status_code == 200)

    r = s.request('WHEN',url+'coffee',auth=creds)
    b = (r.text == "Milk is served." and r.status_code == 200)

    r = s.request('GET',url+'coffee',auth=creds)
    c = (r.text == 'Here is your coffee: INSA{April_Fool_of_Coffee_Machine}' and r.status_code == 200 )
    return a and b and c

print(alive() and exploitable())
